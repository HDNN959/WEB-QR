<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Scanner - Buku Tamu Pernikahan</title>
    <!-- Library untuk QR Scanner -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Three.js untuk efek 3D -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <!-- Font & Ikon -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            color: #f5f5f5;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Background Partikel 3D */
        #admin-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            opacity: 0.7;
        }

        /* Overlay Gradien */
        .gradient-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(248, 200, 220, 0.08) 0%, transparent 50%);
            z-index: -1;
        }

        /* Container Utama */
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header Admin */
        .admin-header {
            text-align: center;
            padding: 30px 20px;
            margin-bottom: 20px;
            position: relative;
            animation: fadeInDown 1s ease;
        }

        .admin-title {
            font-family: 'Dancing Script', cursive;
            font-size: 3.5rem;
            background: linear-gradient(135deg, #d4af37 0%, #f8c8dc 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            text-shadow: 0 5px 15px rgba(212, 175, 55, 0.2);
        }

        .admin-subtitle {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            color: #b0b0b0;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .admin-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 25px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            min-width: 180px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(212, 175, 55, 0.15);
            border-color: rgba(212, 175, 55, 0.4);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #d4af37;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #a0a0a0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Konten Utama - Dua Kolom */
        .admin-main {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 40px;
            flex: 1;
        }

        /* Kolom Scanner */
        .scanner-column {
            flex: 1;
            min-width: 400px;
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .scanner-column:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #d4af37, #f8c8dc, #d4af37);
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: #f0f0f0;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .section-title i {
            color: #d4af37;
        }

        /* Scanner Container */
        .scanner-wrapper {
            position: relative;
            width: 100%;
            margin: 0 auto 25px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(212, 175, 55, 0.4);
        }

        #video {
            width: 100%;
            display: block;
            background: #000;
        }

        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 280px;
            border: 3px solid #4CAF50;
            border-radius: 15px;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7),
                        inset 0 0 20px rgba(76, 175, 80, 0.3);
            animation: pulseBorder 2s infinite;
            pointer-events: none;
            z-index: 2;
        }

        .scan-overlay:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        /* Kontrol Scanner */
        .scanner-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        .admin-btn {
            flex: 1;
            min-width: 140px;
            padding: 16px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-scan {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-stop {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .btn-export {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }

        .btn-excel {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
        }

        .admin-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.4);
        }

        .admin-btn:active {
            transform: translateY(0);
        }

        /* Status Scanner */
        .scanner-status {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #d4af37;
        }

        .status-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-text i {
            color: #d4af37;
        }

        #lastData {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            word-break: break-word;
        }

        /* Kolom Data Tamu */
        .data-column {
            flex: 1;
            min-width: 400px;
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .data-column:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #f8c8dc, #d4af37, #f8c8dc);
        }

        /* Tabel Data */
        .data-table-container {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #dataTable {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        #dataTable thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #dataTable th {
            background: rgba(212, 175, 55, 0.2);
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            color: #f0f0f0;
            border-bottom: 2px solid rgba(212, 175, 55, 0.3);
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        #dataTable td {
            padding: 16px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #ccc;
            transition: background 0.3s;
        }

        #dataTable tbody tr:hover {
            background: rgba(212, 175, 55, 0.08);
        }

        #dataTable tbody tr.new-entry {
            animation: highlightRow 3s;
        }

        .guest-name {
            font-weight: 600;
            color: #f0f0f0;
        }

        .guest-address {
            font-size: 0.9rem;
            color: #aaa;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .guest-time {
            font-family: monospace;
            font-size: 0.85rem;
            color: #888;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-present {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status-waiting {
            background: rgba(255, 193, 7, 0.2);
            color: #FFC107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        /* Footer Admin */
        .admin-footer {
            text-align: center;
            padding: 25px;
            color: #888;
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            margin-top: auto;
        }

        .footer-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }

        .footer-links a {
            color: #d4af37;
            text-decoration: none;
            margin: 0 15px;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: #f8c8dc;
            text-decoration: underline;
        }

        /* Animasi */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulseBorder {
            0% { border-color: #4CAF50; box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7), inset 0 0 20px rgba(76, 175, 80, 0.3); }
            50% { border-color: #8BC34A; box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.6), inset 0 0 30px rgba(139, 195, 74, 0.5); }
            100% { border-color: #4CAF50; box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7), inset 0 0 20px rgba(76, 175, 80, 0.3); }
        }

        @keyframes highlightRow {
            0% { background: rgba(212, 175, 55, 0.3); }
            100% { background: transparent; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsif */
        @media (max-width: 1100px) {
            .admin-main {
                flex-direction: column;
            }
            
            .scanner-column, .data-column {
                min-width: 100%;
            }
            
            .admin-title {
                font-size: 2.8rem;
            }
            
            .stat-box {
                min-width: 150px;
                padding: 12px 20px;
            }
            
            .stat-number {
                font-size: 2rem;
            }
        }

        @media (max-width: 768px) {
            .admin-container {
                padding: 15px;
            }
            
            .admin-title {
                font-size: 2.2rem;
            }
            
            .admin-subtitle {
                font-size: 1.1rem;
            }
            
            .scanner-column, .data-column {
                padding: 20px;
            }
            
            .scanner-controls {
                flex-direction: column;
            }
            
            .admin-btn {
                width: 100%;
            }
            
            .scan-overlay {
                width: 220px;
                height: 220px;
            }
            
            .footer-info {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Scrollbar Custom */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.5);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 175, 55, 0.7);
        }
    </style>
</head>
<body>
    <!-- Background Partikel 3D -->
    <div id="admin-particles"></div>
    <div class="gradient-overlay"></div>

    <!-- Container Utama -->
    <div class="admin-container">
        <!-- Header -->
        <header class="admin-header">
            <h1 class="admin-title">
                <i class="fas fa-crown"></i> Admin Scanner
            </h1>
            <p class="admin-subtitle">Dashboard Pengelolaan Tamu Undangan</p>
            
            <!-- Statistik -->
            <div class="admin-stats">
                <div class="stat-box">
                    <span class="stat-number" id="totalGuests">0</span>
                    <span class="stat-label">Total Tamu</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number" id="presentToday">0</span>
                    <span class="stat-label">Hadir Hari Ini</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number" id="scannedNow">0</span>
                    <span class="stat-label">Baru Di-scan</span>
                </div>
            </div>
        </header>

        <!-- Konten Utama -->
        <main class="admin-main">
            <!-- Kolom Scanner -->
            <section class="scanner-column">
                <h2 class="section-title">
                    <i class="fas fa-qrcode"></i> Scanner QR Code
                </h2>
                
                <!-- Area Scanner -->
                <div class="scanner-wrapper">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas" style="display: none;"></canvas>
                    <div class="scan-overlay"></div>
                </div>
                
                <!-- Kontrol Scanner -->
                <div class="scanner-controls">
                    <button id="startButton" class="admin-btn btn-scan">
                        <i class="fas fa-play-circle"></i> Mulai Scan
                    </button>
                    <button id="stopButton" class="admin-btn btn-stop">
                        <i class="fas fa-stop-circle"></i> Stop Scan
                    </button>
                    <button id="exportExcel" class="admin-btn btn-excel">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button id="clearData" class="admin-btn btn-export">
                        <i class="fas fa-trash-alt"></i> Hapus Data
                    </button>
                </div>
                
                <!-- Status Scanner -->
                <div class="scanner-status">
                    <div class="status-text">
                        <i class="fas fa-info-circle"></i>
                        <strong>Status:</strong> <span id="status">Kamera belum diaktifkan</span>
                    </div>
                    <div class="status-text" style="margin-top: 15px;">
                        <i class="fas fa-user-check"></i>
                        <strong>Data Terakhir:</strong>
                    </div>
                    <div id="lastData" style="margin-top: 10px;">-</div>
                </div>
            </section>

            <!-- Kolom Data Tamu -->
            <section class="data-column">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 class="section-title">
                        <i class="fas fa-users"></i> Daftar Tamu
                    </h2>
                    <div style="font-size: 0.9rem; color: #aaa;">
                        <i class="fas fa-history"></i> Update: <span id="lastUpdate">-</span>
                    </div>
                </div>
                
                <!-- Tabel Data -->
                <div class="data-table-container">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama Tamu</th>
                                <th>Alamat / Asal</th>
                                <th>Waktu Kehadiran</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data akan dimuat di sini -->
                            <tr id="noDataRow">
                                <td colspan="5" style="text-align: center; padding: 50px 20px; color: #666;">
                                    <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; display: block; color: #444;"></i>
                                    Belum ada data tamu. Mulai scan QR code untuk menampilkan data.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination & Info -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 25px; font-size: 0.9rem; color: #888;">
                    <div>
                        Menampilkan <span id="displayCount">0</span> dari <span id="totalCount">0</span> tamu
                    </div>
                    <div>
                        <button id="prevPage" class="admin-btn" style="padding: 8px 15px; min-width: auto; font-size: 0.8rem;">‚Üê Sebelumnya</button>
                        <span style="margin: 0 10px;">Halaman <span id="currentPage">1</span></span>
                        <button id="nextPage" class="admin-btn" style="padding: 8px 15px; min-width: auto; font-size: 0.8rem;">Selanjutnya ‚Üí</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="admin-footer">
            <p>
                <i class="fas fa-heart" style="color: #e91e63;"></i> 
                Dashboard Admin Pernikahan Sarah & Ryan 
                <i class="fas fa-heart" style="color: #e91e63;"></i>
            </p>
            <p>Juma'at, 14 2020 ‚Ä¢ Gedung Sujono Lumajang</p>
            
            <div class="footer-info">
                <div>
                    <i class="fas fa-laptop-code"></i> Sistem Buku Tamu Digital v2.0
                </div>
                <div class="footer-links">
                    <a href="/" target="_blank"><i class="fas fa-external-link-alt"></i> Halaman Tamu</a>
                    <a href="#" id="refreshData"><i class="fas fa-sync-alt"></i> Refresh Data</a>
                    <a href="#" id="helpBtn"><i class="fas fa-question-circle"></i> Bantuan</a>
                </div>
                <div>
                    <i class="fas fa-shield-alt"></i> Status: <span style="color: #4CAF50;">‚óè</span> Online
                </div>
            </div>
        </footer>
    </div>

    <script>
        // ==================== INISIALISASI VARIABEL ====================
        let scannedData = [];
        let scanning = false;
        let videoStream = null;
        let currentPage = 1;
        const itemsPerPage = 10;
        
        // Elemen DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const exportExcelButton = document.getElementById('exportExcel');
        const clearDataButton = document.getElementById('clearData');
        const refreshDataButton = document.getElementById('refreshData');
        const statusElement = document.getElementById('status');
        const lastDataElement = document.getElementById('lastData');
        const tableBody = document.getElementById('tableBody');
        const noDataRow = document.getElementById('noDataRow');
        const helpBtn = document.getElementById('helpBtn');
        
        // Statistik
        const totalGuestsElement = document.getElementById('totalGuests');
        const presentTodayElement = document.getElementById('presentToday');
        const scannedNowElement = document.getElementById('scannedNow');
        const lastUpdateElement = document.getElementById('lastUpdate');
        const displayCountElement = document.getElementById('displayCount');
        const totalCountElement = document.getElementById('totalCount');
        const currentPageElement = document.getElementById('currentPage');
        const prevPageButton = document.getElementById('prevPage');
        const nextPageButton = document.getElementById('nextPage');

        // ==================== BACKGROUND PARTIKEL 3D ====================
        function initAdminParticles() {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('admin-particles').appendChild(renderer.domElement);
            
            // Buat partikel dalam bentuk cincin (ring)
            const particlesGeometry = new THREE.BufferGeometry();
            const count = 2000;
            const positions = new Float32Array(count * 3);
            const colors = new Float32Array(count * 3);
            
            for(let i = 0; i < count * 3; i += 3) {
                // Distribusi partikel dalam bentuk torus (cincin)
                const radius = 5 + Math.random() * 10;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.random() * Math.PI * 2;
                
                positions[i] = radius * Math.sin(theta) * Math.cos(phi);
                positions[i+1] = radius * Math.sin(theta) * Math.sin(phi);
                positions[i+2] = radius * Math.cos(theta);
                
                // Warna emas dan pink
                const colorChoice = Math.random();
                if(colorChoice < 0.7) {
                    colors[i] = 0.831;   // R (emas)
                    colors[i+1] = 0.686; // G
                    colors[i+2] = 0.216; // B
                } else {
                    colors[i] = 0.973;   // R (pink)
                    colors[i+1] = 0.784; // G
                    colors[i+2] = 0.863; // B
                }
            }
            
            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            particlesGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            
            const particlesMaterial = new THREE.PointsMaterial({
                size: 0.03,
                vertexColors: true,
                transparent: true,
                opacity: 0.6,
                blending: THREE.AdditiveBlending
            });
            
            const particles = new THREE.Points(particlesGeometry, particlesMaterial);
            scene.add(particles);
            
            camera.position.z = 25;
            
            // Animasi partikel
            function animate() {
                requestAnimationFrame(animate);
                particles.rotation.x += 0.0002;
                particles.rotation.y += 0.0005;
                particles.rotation.z += 0.0001;
                renderer.render(scene, camera);
            }
            
            animate();
            
            // Responsif
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // ==================== MANAJEMEN DATA ====================
        function loadData() {
            const saved = localStorage.getItem('weddingGuests');
            if(saved) {
                scannedData = JSON.parse(saved);
                updateStats();
                updateTable();
                updatePagination();
            }
            lastUpdateElement.textContent = new Date().toLocaleTimeString('id-ID');
        }

        function saveData() {
            localStorage.setItem('weddingGuests', JSON.stringify(scannedData));
            updateStats();
        }

        function updateStats() {
            totalGuestsElement.textContent = scannedData.length;
            
            // Hitung tamu hadir hari ini
            const today = new Date().toDateString();
            const presentToday = scannedData.filter(guest => {
                const guestDate = new Date(guest.timestamp).toDateString();
                return guestDate === today;
            }).length;
            presentTodayElement.textContent = presentToday;
            
            // Hitung yang baru di-scan (dalam 5 menit terakhir)
            const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
            const scannedNow = scannedData.filter(guest => 
                new Date(guest.timestamp) > fiveMinutesAgo
            ).length;
            scannedNowElement.textContent = scannedNow;
            
            totalCountElement.textContent = scannedData.length;
        }

        // ==================== TABEL & PAGINATION ====================
        function updateTable() {
            if(scannedData.length === 0) {
                noDataRow.style.display = '';
                tableBody.innerHTML = '<tr id="noDataRow"><td colspan="5" style="text-align: center; padding: 50px 20px; color: #666;"><i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; display: block; color: #444;"></i>Belum ada data tamu. Mulai scan QR code untuk menampilkan data.</td></tr>';
                return;
            }
            
            noDataRow.style.display = 'none';
            
            // Hitung data untuk halaman saat ini
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, scannedData.length);
            const pageData = scannedData.slice(startIndex, endIndex);
            
            displayCountElement.textContent = `${startIndex + 1}-${endIndex}`;
            currentPageElement.textContent = currentPage;
            
            // Update tombol pagination
            prevPageButton.disabled = currentPage === 1;
            nextPageButton.disabled = endIndex >= scannedData.length;
            
            // Render baris tabel
            tableBody.innerHTML = '';
            pageData.forEach((guest, index) => {
                const actualIndex = startIndex + index;
                const row = document.createElement('tr');
                
                // Tentukan apakah data baru (dalam 2 menit terakhir)
                const isNew = (Date.now() - new Date(guest.timestamp).getTime()) < 120000;
                if(isNew) row.classList.add('new-entry');
                
                row.innerHTML = `
                    <td>${actualIndex + 1}</td>
                    <td>
                        <div class="guest-name">${guest.n || guest.nama || 'Tidak Diketahui'}</div>
                        ${guest.u ? `<div style="font-size:0.8rem;color:#888;margin-top:4px;"><i>"${guest.u}"</i></div>` : ''}
                    </td>
                    <td class="guest-address">${guest.a || guest.alamat || '-'}</td>
                    <td class="guest-time">${new Date(guest.timestamp).toLocaleString('id-ID')}</td>
                    <td><span class="status-badge status-present">Hadir</span></td>
                `;
                
                // Efek highlight untuk data baru
                if(isNew) {
                    setTimeout(() => row.classList.remove('new-entry'), 3000);
                }
                
                tableBody.appendChild(row);
            });
        }

        function updatePagination() {
            currentPage = 1;
            updateTable();
        }

        // ==================== SCANNER QR CODE ====================
        startButton.addEventListener('click', async () => {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                video.srcObject = videoStream;
                scanning = true;
                statusElement.innerHTML = '<i class="fas fa-search"></i> <strong>SCANNING...</strong> Arahkan kamera ke QR Code tamu';
                statusElement.style.color = "#4CAF50";
                
                // Update UI
                startButton.disabled = true;
                stopButton.disabled = false;
                startButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
                
                // Mulai loop scan
                scanQRCode();
            } catch (err) {
                console.error("Error kamera:", err);
                statusElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Gagal mengakses kamera: ${err.message}`;
                statusElement.style.color = "#f44336";
                startButton.disabled = false;
                startButton.innerHTML = '<i class="fas fa-play-circle"></i> Mulai Scan';
            }
        });

        stopButton.addEventListener('click', () => {
            scanning = false;
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            statusElement.innerHTML = '<i class="fas fa-pause-circle"></i> Scanner dihentikan';
            statusElement.style.color = "#FF9800";
            
            // Update UI
            startButton.disabled = false;
            stopButton.disabled = true;
            startButton.innerHTML = '<i class="fas fa-play-circle"></i> Mulai Scan';
        });

        function scanQRCode() {
            if (!scanning || !videoStream) return;
            
            const canvasElement = document.getElementById('canvas');
            const canvasContext = canvasElement.getContext('2d', { willReadFrequently: true });
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasElement.width = video.videoWidth;
                canvasElement.height = video.videoHeight;
                canvasContext.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvasContext.getImageData(0, 0, canvasElement.width, canvasElement.height);
                
                // Decode QR Code
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (code) {
                    try {
                        let data;
                        try {
                            data = JSON.parse(code.data);
                        } catch (e) {
                            // Format alternatif jika bukan JSON
                            data = { 
                                n: code.data.split('|')[0] || "Tamu Undangan", 
                                a: code.data.split('|')[1] || "Tidak Diketahui" 
                            };
                        }
                        
                        // Ekstrak data (dukung format lama dan baru)
                        const guestName = data.n || data.nama || "Tamu Undangan";
                        const guestAddress = data.a || data.alamat || "Tidak Diketahui";
                        const guestWish = data.u || "";
                        
                        // Cek duplikat (dalam 10 detik terakhir)
                        const isDuplicate = scannedData.some(guest => 
                            (guest.n === guestName || guest.nama === guestName) &&
                            (new Date() - new Date(guest.timestamp) < 10000)
                        );
                        
                        if (!isDuplicate) {
                            // Format data baru
                            const newGuest = {
                                id: Date.now(),
                                timestamp: new Date().toISOString(),
                                n: guestName,
                                a: guestAddress,
                                u: guestWish,
                                status: 'Hadir'
                            };
                            
                            // Tambah ke awal array
                            scannedData.unshift(newGuest);
                            saveData();
                            
                            // Update tampilan
                            updateTable();
                            updateStats();
                            
                            // Tampilkan data terakhir
                            lastDataElement.innerHTML = `
                                <div><strong>${guestName}</strong></div>
                                <div style="font-size:0.9rem;color:#aaa;">${guestAddress}</div>
                                ${guestWish ? `<div style="font-style:italic;margin-top:5px;color:#888;">"${guestWish.substring(0,50)}${guestWish.length > 50 ? '...' : ''}"</div>` : ''}
                                <div style="font-size:0.8rem;margin-top:5px;color:#4CAF50;">‚úî Berhasil dicatat ${new Date().toLocaleTimeString('id-ID')}</div>
                            `;
                            
                            // Notifikasi suara (opsional)
                            playScanSound();
                            
                            // Feedback visual
                            statusElement.innerHTML = '<i class="fas fa-check-circle"></i> <strong>BERHASIL!</strong> Data tamu tersimpan';
                            statusElement.style.color = "#4CAF50";
                            
                            // Berhenti scan sementara (2 detik)
                            scanning = false;
                            setTimeout(() => {
                                scanning = true;
                                statusElement.innerHTML = '<i class="fas fa-search"></i> <strong>SCANNING...</strong> Arahkan ke QR berikutnya';
                                scanQRCode();
                            }, 2000);
                            
                            return;
                        } else {
                            statusElement.innerHTML = '<i class="fas fa-info-circle"></i> Data tamu sudah discan baru saja';
                            statusElement.style.color = "#FF9800";
                        }
                    } catch (e) {
                        console.error("Error proses QR:", e);
                        statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Format QR tidak dikenali';
                        statusElement.style.color = "#f44336";
                    }
                }
            }
            
            if (scanning) {
                requestAnimationFrame(scanQRCode);
            }
        }

        // ==================== FUNGSI TAMBAHAN ====================
        function playScanSound() {
            try {
                // Buat audio context untuk beep sederhana
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log("Audio tidak didukung");
            }
        }

        // ==================== EVENT LISTENERS ====================
        exportExcelButton.addEventListener('click', () => {
            if (scannedData.length === 0) {
                alert("üì≠ Belum ada data tamu untuk di-export!");
                return;
            }
            
            // Format data untuk Excel
            const worksheetData = [
                ["NO", "NAMA TAMU", "ALAMAT/ASAL", "UCAPAN/DOA", "WAKTU KEHADIRAN", "STATUS"],
                ...scannedData.map((guest, index) => [
                    index + 1,
                    guest.n || guest.nama,
                    guest.a || guest.alamat,
                    guest.u || "-",
                    new Date(guest.timestamp).toLocaleString('id-ID'),
                    "Hadir"
                ])
            ];
            
            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Daftar Tamu");
            
            // Format nama file
            const dateStr = new Date().toISOString().slice(0,10).replace(/-/g, '');
            const filename = `Daftar_Tamu_Pernikahan_${dateStr}.xlsx`;
            
            XLSX.writeFile(workbook, filename);
            
            // Feedback
            statusElement.innerHTML = `<i class="fas fa-file-excel"></i> File <strong>${filename}</strong> berhasil di-download!`;
            statusElement.style.color = "#FF9800";
        });

        clearDataButton.addEventListener('click', () => {
            if(confirm("‚ö†Ô∏è APAKAH ANDA YAKIN?\n\nSemua data tamu akan dihapus permanen. Aksi ini tidak dapat dibatalkan.")) {
                scannedData = [];
                localStorage.removeItem('weddingGuests');
                updateStats();
                updateTable();
                lastDataElement.textContent = "-";
                statusElement.innerHTML = '<i class="fas fa-trash-alt"></i> Semua data telah dihapus';
                statusElement.style.color = "#f44336";
            }
        });

        refreshDataButton.addEventListener('click', () => {
            loadData();
            statusElement.innerHTML = '<i class="fas fa-sync-alt"></i> Data diperbarui';
            statusElement.style.color = "#2196F3";
            setTimeout(() => {
                if(!scanning) {
                    statusElement.innerHTML = '<i class="fas fa-pause-circle"></i> Scanner dihentikan';
                    statusElement.style.color = "#FF9800";
                }
            }, 2000);
        });

        helpBtn.addEventListener('click', () => {
            alert("üìã PANDUAN ADMIN:\n\n1. Klik 'Mulai Scan' untuk mengaktifkan kamera\n2. Arahkan QR Code tamu ke dalam kotak scanner\n3. Data akan otomatis tersimpan\n4. Gunakan 'Export Excel' untuk mendownload data\n5. 'Hapus Data' untuk mengosongkan semua data\n\nPastikan koneksi internet stabil untuk pengalaman terbaik.");
        });

        prevPageButton.addEventListener('click', () => {
            if(currentPage > 1) {
                currentPage--;
                updateTable();
            }
        });

        nextPageButton.addEventListener('click', () => {
            if(currentPage * itemsPerPage < scannedData.length) {
                currentPage++;
                updateTable();
            }
        });

        // ==================== INISIALISASI ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Mulai partikel 3D
            initAdminParticles();
            
            // Load data dari localStorage
            loadData();
            
            // Update waktu setiap menit
            setInterval(() => {
                lastUpdateElement.textContent = new Date().toLocaleTimeString('id-ID');
            }, 60000);
            
            // Auto-focus untuk UX
            setTimeout(() => {
                if(scannedData.length === 0) {
                    statusElement.innerHTML = '<i class="fas fa-play-circle"></i> Klik "Mulai Scan" untuk memulai';
                }
            }, 1000);
        });
    </script>
</body>
</html>

